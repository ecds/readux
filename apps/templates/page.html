{% extends "base.html" %}
{% load static i18n %}
{% block extra_css %}
<link href="{% static 'mirador/css/mirador-combined.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block content %}

<div class="rx-title-container">
  <ul class="rx-breadcrumb uk-text-truncate">
    <li class="rx-breadcrumb-item"><a href="/" alt="Home">Home</a></li>
    <li class="rx-breadcrumb-item"><a href="/collections/" alt="Collections">Collections</a></li>
    <li class="rx-breadcrumb-item"><a href="{% url 'collection' volume.collections.first.pid %}"
        alt="Collections">{{ volume.collections.first.label }}</a></li>
  </ul>
  <div class="rx-title uk-text-truncate">{{volume.label}}</div>
</div>

<!-- new search form -->
{% if page.pid is not None %}
<form class="uk-search uk-search-default" action="{% url 'page' volume.pid page.pid %}" method="get"
  accept-charset="utf-8">
  <!-- <span uk-search-icon></span>&nbsp; -->
  <input class="form-control mr-sm-2" type="text" placeholder="Search this volume" aria-label="Search" name="q">
  <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
</form>
{% else %}
<form class="uk-search uk-search-default" action="{% url 'volumeall' volume.pid %}" method="get" accept-charset="utf-8">
  <!-- <span uk-search-icon></span>&nbsp; -->
  <input class="form-control mr-sm-2" type="text" placeholder="Search this volume" aria-label="Search" name="q">
  <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
</form>
{% endif %}
<!-- new search form -->

<!-- old search form -->
<form class="uk-search uk-search-default" style="width: calc(100% - 42px) !important;">
  <span uk-search-icon></span>
  <input class="uk-search-input" type="search" placeholder="Search this volume..."
    style="padding-right: 0; padding-top: 0; padding-bottom: 0;">
</form>
<!-- old search form -->

{% endblock content %}

{% block viewer %}

<div class="uk-flex-middle" uk-grid>
  <div class="uk-width-2-3@m uk-flex-first">
    <div id="viewer"></div>
  </div>

  <div class="uk-width-1-3@m rx-info-container">
    <div class="rx-info">
      <div class="rx-info-title">Basic Information</div>
      <div class="rx-info-content-container">
        <div class="rx-info-content">
          <div class="rx-info-content-label">Authors</div>
          <div class="rx-info-content-value">{{ volume.author }}</div>
        </div>
  
        <div class="rx-info-content">
          <div class="rx-info-content-label">Publication Date</div>
          <div class="rx-info-content-value">{{ volume.published_date }}</div>
        </div>
  
        <div class="rx-info-content">
          <div class="rx-info-content-label">Collections</div>
          <div class="rx-info-content-value">
            {% for col in volume.collections.all %}
            <a class="nav-link" href="{% url 'collection' col.pid %}">{{ col.label }}</a>
            {% endfor %}
          </div>
        </div>
  
        <div class="rx-info-content">
          <div class="rx-info-content-label">Publisher</div>
          <div class="rx-info-content-value">{{ volume.published_city }} : {{ volume.publisher }}</div>
        </div>
  
        <div class="rx-info-content">
          <div class="rx-info-content-label">Notes</div>
          <div class="rx-info-content-value">
            <ul>
              {% for note in volume.note_set.all %}
              <li>{{ note.label }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
  
      </div>
    </div>
  
    <div class="rx-info">
      <div class="rx-info-title">Actions</div>
      <div class="rx-info-content-container">
        <div class="rx-info-content">
          <a class="rx-action-btn" href="{{volume.pdf}}" target="_blank">View Volume PDF</a>
        </div>
        <div class="rx-info-content">
          <a class="rx-action-btn" href="https://{{ request.META.HTTP_HOST }}{% url 'ris' volume.pid %}"
            target="_blank">Export Citation in RIS</a>
        </div>

      </div>
    </div>
  
    <div class="rx-info">
      <div class="rx-info-title">URLs</div>
      <div class="rx-info-content-container">
        <div class="rx-info-content">
          <div class="rx-info-content-label">Manifest</div>
          <div class="rx-info-content-value">
            <a href="https://{{ request.META.HTTP_HOST }}{% url 'ManifestRender' 'v2' volume.pid %}"
              target="_blank">https://{{ request.META.HTTP_HOST }}{% url 'ManifestRender' 'v2' volume.pid %}</a>
          </div>
        </div>
  
        <div class="rx-info-content">
          <div class="rx-info-content-label">Manifest</div>
          <div class="rx-info-content-value">
            <a href="https://{{ request.META.HTTP_HOST }}{% url 'ManifestRender' 'v2' volume.pid %}"
              target="_blank">https://{{ request.META.HTTP_HOST }}{% url 'ManifestRender' 'v2' volume.pid %}</a>
          </div>
        </div>
  
        <div class="rx-info-content">
          <div class="rx-info-content-label">Collection Manifest</div>
          <div class="rx-info-content-value">
            {% for col in volume.collections.all %}
            <a href="https://{{ request.META.HTTP_HOST }}{% url 'CollectionRender' 'v2' col.pid %}"
              target="_blank">https://{{ request.META.HTTP_HOST }}{% url 'CollectionRender' 'v2' col.pid %}</a>
            {% endfor %}
          </div>
        </div>
  
        <div class="rx-info-content">
          <div class="rx-info-content-label">Stable Volume</div>
          <div class="rx-info-content-value">
            <a href="https://{{ request.META.HTTP_HOST }}{% url 'volume' volume.pid %}/page/all"
              target="_blank">https://{{ request.META.HTTP_HOST }}{% url 'volume' volume.pid %}/page/all</a>
          </div>
  
        </div>
  
        {% if page.pid is not None %}
        <div class="rx-info-content">
          <div class="rx-info-content-label">Canvas</div>
          <div class="rx-info-content-value">
            <span class="link" id="myLink"></span>
          </div>
        </div>
  
        <div class="rx-info-content">
          <div class="rx-info-content-label">Stable Page</div>
          <div class="rx-info-content-value">
            <span class="link" id="mySpan"></span>
            <!--new-->
            <br />{% if user_annotation_count > 0 %}
            <b>My annotations (this manifest):</b> {{ user_annotation_count }}
            <!-- The my annotations elements will need to be cleaned up when the annotation model changes are fully finished. -->
            <br />
            <b>My annotations (this page):</b> {{ user_annotation_page_count }}
            <br />{% endif %}

            <div>
              {% if qs1 %}
              <hr />
              <p><strong>The results of the search query in text: {{ request.GET.q }}</strong></p>
              <ul>{% for answer in qs1 %}{% if answer.canvas.manifest.label in volume.label %}
                <li><a href="https://{{ request.META.HTTP_HOST }}{% url 'volume' volume.pid %}/page/{{ answer.canvas.pid }}"
                    target="_blank">Canvas {{ answer.canvas.position }}</a></li>
                {% endif %}{% endfor %}</ul>
              {% elif request.GET.q  and not qs1 %}
              <hr />
              <p>No results in the text in this volume</p>{% endif %}
              {% if qs2 %}
              <p><strong>The results of the search query in your annotations: {{ request.GET.q }}</strong></p>
              <ul>{% for answer in qs2 %}{% if answer.canvas.manifest.label in volume.label %}
                <li><a href="https://{{ request.META.HTTP_HOST }}{% url 'volume' volume.pid %}/page/{{ answer.canvas.pid }}"
                    target="_blank">Canvas {{ answer.canvas.position }}</a></li>
                {% endif %}{% endfor %}</ul>
              {% elif request.GET.q  and not qs2 %}<p>No results in your annotations in this volume</p>
              {% endif %}
            </div>
            <!--new-->
            {% if user_annotation_count > 0 %}
            <form action="{% url 'export' volume.pid %}" class="button_to" method="GET">
              <div><input type="submit" value="Export" title="Export in a variety of formats" />{% csrf_token %}</div>
            </form>
            {% endif %}
            {% endif %}

          </div>
        </div>
  
      </div>
  
    </div>
  
    <!-- start ocr el -->
    <div id="ocr" style="opacity: 0;"></div>
    <!-- end ocr el -->
  </div>
  
</div>

        
        
          {% if page.pid is not None %}

<!-- 
        <p id="test"></p>
        <a class="facebook" href='http://www.facebook.com/sharer.php?s=100&p[url]=http://{{ request.META.HTTP_HOST }}{{ request.path }}&p[images][0]{{ page.IIIF_IMAGE_SERVER_BASE }}{{ page.pid }}/full/600,/0/default.jpg' target="_blank">
        <img src="https://www.cabq.gov/culturalservices/biopark/images/share-on-facebook.png/@@images/image.png" title="Facebook" alt="Facebook" ></a>
-->
  {% endif %}

{% endblock viewer %}

{% block extra_javascript %}
<script src="{% static 'mirador/mirador.js' %}"></script>
<script type="text/javascript">

  $(function() {
    Mirador({
      "id": "viewer",
      "mainMenuSettings" : {
        'show' : false,
        'buttons' : {
          info: false
        }
      },
      "layout": "1x1",
      "data": [
        {
          "manifestUri": "https://{{ request.META.HTTP_HOST }}/iiif/v2/{{ volume.pid }}/manifest", "location": "Emory University"
        }
      ],
      'windowSettings' : {
        "overlay" : true,
        "canvasControls": {}
      },
      "windowObjects": [{
        loadedManifest: "https://{{ request.META.HTTP_HOST }}/iiif/v2/{{ volume.pid }}/manifest",
        annotationLayer: true,
        annotationCreation: true,
        annotationState: 'annoOncreateOn',{% if page.pid is not None %}
        canvasID: 'https://{{ request.META.HTTP_HOST }}/iiif/{{ page.manifest.pid }}/canvas/{{ page.pid }}',{% endif %}
        displayLayout: false,
        sidePanel: false,
        {% if "/page/all" in request.get_full_path %}
        canvasID: 'https://{{ request.META.HTTP_HOST }}/iiif/{{ volume.pid }}/canvas/{{ volume.canvas_set.pid.first }}',
        viewType: "ThumbnailsView"
        {% endif %}
      }],
      {% if user.is_anonymous %}
        "availableAnnotationDrawingTools": [],
        "availableAnnotationStylePickers": [],
      {% else %}
        username: '{{user.get_username}}',
      {% endif %}
      "annotationEndpoint": { "name":"Readux", "module": "ReaduxEndpoint" }
    });
  });

// var topHeight = $(".uk-navbar").height() + $(".rx-title-container").height() + $(".uk-navbar").height();
//   $('#viewer').css({ height: `calc(100% - ${topHeight}px)` });

//   var offset = 11;
//   var height = $("#viewer").height() + offset;
//   $(".rx-info-container").height(height);

//   $(window).resize(function () {
//     var height = $("#viewer").height() + offset;
//     $(".rx-info-container").height(height);
//   });
</script>
{% endblock extra_javascript %}