{% extends 'site_base.html' %}
{% load static widget_tweaks readux_utils %}


{% block page-subtitle %}{{ vol.display_label }} | Export {% endblock %}

{% block javascript %}
  {{ block.super }}
   <script type="text/javascript" src="{% static 'ext/js.cookie.js' %}"></script>
  <script type="text/javascript" src="//emory-lits-labs.github.io/annotator-meltdown-zotero/build/0.1.0/annotator.meltdown.zotero.min.js"></script> <!-- includes jquery-ui autocomplete -->
  <link rel="stylesheet" type="text/css" href="//emory-lits-labs.github.io/annotator-meltdown-zotero/build/0.1.0/annotator.meltdown.zotero.min.css" />

{% endblock %}

{% block content %}
<div class="container">

    {% include 'books/snippets/volume_header.html' %}

    {% if user.is_anonymous %}
      {# display a warning to users who are not logged in #}
      <div class="alert alert-warning">Export functionality is only available
      to logged in users.</div>

      <p>To export an annotated edition of this volume or any other,
      please log in.</p>
    {% else %}
    {% if warning %}
    <div class="alert alert-warning">
      <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
      {{ warning }}</div>
    {% endif %}

    {% if github_export %}
      <div class="alert alert-success">GitHub jekyll site export succeeded.</div>

      <p>Your website export has been generated and saved to a new
      GitHub repository at <a href="{{ repo_url }}">{{ repo_url }}</a>.
      Your annotated web edition should now be accessible via GitHub Pages
      at <a href="{{ ghpages_url }}">{{ ghpages_url }}</a>.</p>

      <p>For more information on using and customizing your site,
      see the
      <a href="https://help.github.com/categories/github-pages-basics/">Github
      Pages help documentation</a>.</p>

    {% elif github_update %}
      <div class="alert alert-success">GitHub jekyll site update succeeded.</div>

      <p>A new <a href="{{ pullrequest_url }}">pull request</a> has been created
      on your <a href="{{ repo_url }}">GitHub repository</a> with all the latest
      changes.  You can review the changes and merge them into your
      published edition.</p>

    {% else %}

    {{ export_form.non_field_errors }}
    <form class="volume-webexport form-horizontal" method="POST">{% csrf_token %}
    {% for field in export_form %}
    {# TODO: github options should be disabled if user does not have a github account #}
    {# TODO: add visual indication for disabled fields #}
          {% if field.name = 'mode' %}
          {# special handling for export mode radio buttons and help text #}
          <div class="help-block">{{ field.help_text}}</div>
          {% for radio in field %}
            <div class="radio">
              <label for="{{ radio.id_for_label }}">
                  {{ radio.tag }} {{ radio.choice_label}}
              </label>
              {% with forloop.counter|cut:' ' as index %}
                <div class="help-block">{{ export_form.mode_help|slice:index|last }}</div>
              {% endwith %}
            </div>
          {% endfor %}
          <div class="text-warning">{{ field.errors }}</div>

          {% elif field.name = 'annotations' and export_form.hide_annotation_choice %}
          {# hide annotation choice when flag is set (i.e., only one choice available) #}
            {{ field|add_class:"hidden" }}
          {% else %}
        <div class="form-group{% if field.errors %} has-error{% endif %}"{% if field.name = 'github_repo' or field.name = 'update_repo' %}style="display:none"{% endif %}>
            <label for="{{ field.name }}">{{ field.label }}</label>
            {{ field|add_class:"form-control" }}
            <div class="help-block">{{ field.help_text}}</div>
            <div class="text-warning">{{ field.errors }}</div>
            {# TODO: display validation errors, required/optional ? #}
        </div>
        {% endif %}
        {% endfor %}

        <div class="form-group">
          <input type="hidden" name="completion-cookie" value="{{ vol.noid|add:'-web-export' }}"/>
          <button type="submit" class="volume-export btn btn-default">Export</button>
          <span id="export-generating" class="hidden text-info">Generating... <i class="fa fa-cog fa-lg fa-spin"></i></span>
        </div>
        </form>

    {% endif %}

    <script>
    {# Show/hide subportions of the form based on export mode #}
      $(document).ready(function(){
        var transition = 500;
        var github_repo = $("div.form-group:has(#id_github_repo)");
        var update_repo = $("div.form-group:has(#id_update_repo)");
        $("input[type=radio][name=mode]").change(function() {
          // hide everything by default, then show as appropriate by mode
          github_repo.hide(transition);
          update_repo.hide(transition);
          if (this.value == 'github') {
            github_repo.show(transition);
          } else if (this.value == 'github_update') {
            update_repo.show(transition);
          }
        });

        // load github repo data once, and use as variable data source
        // for the update repository autocomplete input
        $.getJSON("{% url 'accounts:github-repos' %}", function( data ) {
            $("#id_update_repo").autocomplete({
                source: data
            });
        });

      });
    </script>

  {% endif %}  {# logged in user #}

    </div>
{% endblock %}
